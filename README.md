
# Innokassa Module for OpenCart 3

Модуль позволяет интегрировать облачную кассу [Innokassa](https://innokassa.ru/) в интернет-магазин на базе OpenCart.

Возможности:
* автоматическая фискализация приходов с настраиваемой схемой (первый и второй чек или только второй чек)
* настройка НДС для доставки
* настройка предмета расчета по умолчанию


## Требования

Системные:
* `OpenCart` >= 3.0.0
* `PHP` >= 7.1

Интернет-магазин должен иметь корректные настройки НДС у товаров.


## Установка

### Архив
Смормировать архив можно при помощи `bash` скрипта [build.bash](/build.bash).

В панели адмниистратора зайти в раздел "Модули/Расширения" => "Установка расширений" и загрузить архив `innokassa.ocmod.zip`.

### Из исходного кода

Загрузить содержимое директории [src](/src) в корень сайта.


## Настройки

* **Ссылка для cron** - для каждого модуля генерируется индивидуальная ссылка (при каждой установке модуля), по данной ссылке необходимо осуществлять запросы с интервалом 10 минут (для синхронизации состояния чеков, которые не смогли пробится при первом запросе)
* **Статус модуля** - модуль может быть установлен, но не включен, в таком случае фискализация заказов не будет осуществляться, кнопка перехода в CRM также будет отсутствовать
* **Идентфиикатор актора** - выдается после заключения договора
* **Токен актора** - выдается после заключения договора
* **Группа касс** - выдается после заключения договора
* **Налогообложение** - должно быть указано как на кассе, касса может иметь несколько видов налогообложений, необходимо выбрать один режим, с которым будут пробиваться чеки
* **НДС доставки** - используется в чеках при автоматической фискализации
* **Адрес сайта** - как указано при регистрации кассы
* **Предмет расчёта по умолчанию** - используется в чеках при автоматической фискализации
* **Статус заказа для первого чека*** - когда заказ получит этот статус будет отправлен чек предоплаты (приход безналичными)
* **Статус заказа для второго чека*** - когда заказ получит этот статус будет отправлен чек полного расчета (зачет аванса по предыдущему чеку, если он был)
* **Схема фискализации**** - доступно 2 вида:
    * Только второй чек - отправлять только второй чек (если доставка заказа покупателю осуществляется в день покупки)
    * Первый и второй чек - чек предоплаты во время оплаты, чек полного расчета после доставки заказа покупателю

> *если не будет выбран статус заказа, значит не будет автоматически пробит данный чек

> **чеки будут автоматически отправляться только если статус заказа меняется на указанный в соответствии со схемой фискализации


## Работа модуля

### Автоматическая фискализация

Каждый заказ фискализируется автоматически, на основании настроек.


### Ручная фискализация и возврат

Ручная фискализация и возврат возможны в [CRM.Innokassa](https://crm.innokassa.ru/).


## Разработка

> Для разработки потребуется `docker` и `docker-compose`

Репозиторий содержит [docker-compose.dev.yml](/docker-compose.dev.yml) для организации среды разработки модуля для OpenCart.

Использованы следующие субмодули `git`:
* [mdk](https://git.innokassa.ru/Byurrer/mdk)
